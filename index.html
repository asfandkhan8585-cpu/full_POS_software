<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizRocket Plus ERP Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f0f2f5;
            --nav-bg: #fff;
            --theme-teal: #17a2b8;
            --theme-blue: #007bff;
            --theme-green: #28a745;
            --theme-orange: #fd7e14;
            --text-dark: #343a40;
            --border-light: #dee2e6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-main); height: 100vh; display: flex; flex-direction: column; }

        /* --- NAVIGATION --- */
        .top-nav {
            background: var(--nav-bg); border-bottom: 1px solid var(--border-light); padding: 5px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-tabs { display: flex; gap: 5px; }
        .nav-tab {
            padding: 10px 15px; cursor: pointer; color: var(--text-dark); border-radius: 4px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .nav-tab:hover { background: #e9ecef; color: var(--theme-blue); }
        .nav-tab.active { background: var(--theme-blue); color: white; }

        /* --- MAIN CONTAINER --- */
        .main-container { flex: 1; padding: 20px; overflow-y: auto; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- DASHBOARD BOXES --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .dash-box {
            padding: 20px; border-radius: 4px; color: white; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .dash-box h4 { font-size: 1.1rem; margin-bottom: 10px; font-weight: 400; }
        .dash-box .amount { font-size: 1.6rem; font-weight: bold; }
        .dash-box.blue { background: linear-gradient(45deg, #007bff, #0062cc); }
        .dash-box.teal { background: linear-gradient(45deg, #17a2b8, #117a8b); }
        .dash-box.green { background: linear-gradient(45deg, #28a745, #218838); }
        .dash-box.orange { background: linear-gradient(45deg, #fd7e14, #dc6b11); }

        /* --- FORMS & TABLES --- */
        .panel { background: white; padding: 20px; border-radius: 4px; border: 1px solid var(--border-light); margin-bottom: 20px; }
        .panel h3 { margin-bottom: 15px; color: var(--text-dark); border-bottom: 2px solid var(--bg-main); padding-bottom: 10px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 4px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px;}
        .btn-primary { background: var(--theme-blue); color: white; } .btn-primary:hover { background: #0056b3; }
        .btn-success { background: var(--theme-green); color: white; } .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-teal { background: var(--theme-teal); color: white; } .btn-teal:hover { background: #117a8b; }
        .btn-outline { border: 1px solid var(--border-light); background: white; color: var(--text-dark); }

        /* Excel-style Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border-light); padding: 8px 12px; text-align: left; }
        th { background: #f8f9fa; color: #495057; }
        tr:hover { background-color: #f2f2f2; }

        /* --- POS SPECIFIC --- */
        .pos-layout { display: flex; gap: 20px; height: calc(100vh - 180px); }
        .pos-left { flex: 2; display: flex; flex-direction: column; }
        .pos-right { flex: 1; background: white; border: 1px solid var(--border-light); display: flex; flex-direction: column; }
        .item-list-container { flex: 1; overflow-y: auto; background: white; border: 1px solid var(--border-light); }
        .cart-items { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-totals { padding: 20px; background: #f8f9fa; border-top: 1px solid var(--border-light); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        
        /* --- TOAST --- */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; left: 50%; bottom: 30px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="top-nav">
        <div style="font-weight: bold; font-size: 1.2rem; color: var(--theme-blue);">BizRocket Clone</div>
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('dashboard')"><i class="fa fa-tachometer-alt"></i> Dashboard</div>
            <div class="nav-tab" onclick="switchView('masters')"><i class="fa fa-users-cog"></i> Masters (Setup)</div>
            <div class="nav-tab" onclick="switchView('products')"><i class="fa fa-box-open"></i> Products & Stock</div>
            <div class="nav-tab" onclick="switchView('pos')"><i class="fa fa-cash-register"></i> POS Transaction</div>
            <div class="nav-tab" onclick="switchView('purchase')"><i class="fa fa-shopping-cart"></i> Purchase</div>
            <div class="nav-tab" onclick="switchView('ledger')"><i class="fa fa-book"></i> Ledger & Accounts</div>
             <div class="nav-tab" onclick="switchView('hr')"><i class="fa fa-user-tie"></i> HR & Expenses</div>
        </div>
        <div>Isabella (Admin)</div>
    </div>

    <div class="main-container">

        <div id="dashboard-view" class="view-section active">
            <div class="dashboard-grid">
                <div class="dash-box blue">
                    <h4><i class="fa fa-chart-line"></i> Total Sales</h4>
                    <div class="amount" id="dash-total-sales">Rs 0.00</div>
                </div>
                <div class="dash-box teal">
                    <h4><i class="fa fa-money-bill-wave"></i> Cash Sales</h4>
                    <div class="amount" id="dash-cash-sales">Rs 0.00</div>
                </div>
                 <div class="dash-box blue" style="background: linear-gradient(45deg, #6610f2, #520dc2);">
                    <h4><i class="fa fa-credit-card"></i> Credit Sales</h4>
                    <div class="amount" id="dash-credit-sales">Rs 0.00</div>
                </div>
            </div>
             <div class="dashboard-grid">
                 <div class="dash-box orange">
                    <h4><i class="fa fa-shopping-basket"></i> Total Purchases</h4>
                    <div class="amount" id="dash-purchases">Rs 0.00</div>
                </div>
                <div class="dash-box teal" style="background: linear-gradient(45deg, #20c997, #17a589);">
                    <h4><i class="fa fa-cubes"></i> Total Stock Value</h4>
                    <div class="amount" id="dash-stock-value">Rs 0.00</div>
                </div>
                 <div class="dash-box green">
                    <h4><i class="fa fa-wallet"></i> Net Profit (Less Expenses)</h4>
                    <div class="amount" id="dash-profit">Rs 0.00</div>
                </div>
            </div>
            <div style="display: flex; gap: 20px; height: 300px;">
                <div class="panel" style="flex: 1; display: flex; align-items: center; justify-content: center; background: #e9ecef;">
                    <i class="fa fa-chart-bar" style="font-size: 4rem; color: #adb5bd;"></i>
                    <p>Sales Graph Placeholder</p>
                </div>
                 <div class="panel" style="flex: 1; display: flex; align-items: center; justify-content: center; background: #e9ecef;">
                    <i class="fa fa-chart-pie" style="font-size: 4rem; color: #adb5bd;"></i>
                     <p>Customer Receivable Placeholder</p>
                </div>
            </div>
        </div>

        <div id="masters-view" class="view-section">
            <div class="panel">
                <h3><i class="fa fa-tags"></i> Product Categories Setup</h3>
                <div class="form-row">
                    <div class="form-group"><input type="text" id="new-category" placeholder="e.g., Electronics"></div>
                    <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
                </div>
                <div id="category-list-display" style="display: flex; gap: 10px; flex-wrap: wrap; padding-top: 10px;"></div>
            </div>

            <div class="panel">
                <h3><i class="fa fa-users"></i> Customer Profiles Setup</h3>
                <div class="form-row">
                    <div class="form-group"><input type="text" id="cust-name" placeholder="Customer Name"></div>
                    <div class="form-group"><input type="text" id="cust-phone" placeholder="Phone Number"></div>
                    <button class="btn btn-teal" onclick="addCustomer()"><i class="fa fa-user-plus"></i> Save Customer</button>
                </div>
                <div class="table-container">
                    <table id="customer-table">
                        <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Current Balance (Ledger)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="products-view" class="view-section">
             <div class="panel">
                <h3><i class="fa fa-box"></i> Add New Product</h3>
                <div class="form-row">
                    <div class="form-group"><label>Barcode</label><input type="text" id="prod-barcode"></div>
                    <div class="form-group"><label>Name</label><input type="text" id="prod-name"></div>
                    <div class="form-group"><label>Category</label><select id="prod-cat"></select></div>
                    <div class="form-group"><label>Cost Price</label><input type="number" id="prod-cost"></div>
                    <div class="form-group"><label>Sale Price</label><input type="number" id="prod-price"></div>
                    <div class="form-group" style="flex:0;"><label>&nbsp;</label><button class="btn btn-success" onclick="addProduct()">Save Product</button></div>
                </div>
            </div>
            <div class="panel">
                <h3>Product List (Excel View)</h3>
                <div class="table-container">
                    <table id="product-table">
                        <thead><tr><th>Barcode</th><th>Name</th><th>Category</th><th>Cost</th><th>Price</th><th>Stock</th><th>Stock Value</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="pos-view" class="view-section">
            <div class="pos-layout">
                <div class="pos-left">
                    <div class="panel" style="margin-bottom: 10px; padding: 15px;">
                        <div class="form-row" style="margin: 0;">
                             <div class="form-group" style="flex: 2;">
                                <input type="text" id="pos-search" placeholder="Search Item Name..." onkeyup="renderPosItemList()">
                            </div>
                             <button class="btn btn-teal" onclick="simulateBarcodeScan()"><i class="fa fa-barcode"></i> Scan Barcode</button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                             <select id="pos-customer-select" style="flex:1;"><option value="">Select Customer for Sale...</option></select>
                             <button class="btn btn-outline" onclick="holdBill()"><i class="fa fa-pause"></i> Hold Bill</button>
                             <button class="btn btn-outline" onclick="showHeldBills()"><i class="fa fa-history"></i> Recall Bill</button>
                        </div>
                    </div>
                    <div class="item-list-container table-container">
                         <table id="pos-item-table">
                            <thead><tr><th>Barcode</th><th>Name</th><th>Stock</th><th>Price</th><th>Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="pos-right">
                    <div style="padding: 15px; background: var(--theme-blue); color: white; font-weight: bold;">
                        <i class="fa fa-shopping-cart"></i> Current Bill
                    </div>
                    <div class="cart-items" id="pos-cart-items">
                        </div>
                    <div class="cart-totals">
                        <div class="total-row">
                            <span>Total:</span>
                            <span id="pos-total-amount">Rs 0.00</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-success" style="justify-content: center;" onclick="processSale('Cash')"><i class="fa fa-money-bill"></i> Cash Sale</button>
                            <button class="btn btn-primary" style="background: #6610f2; justify-content: center;" onclick="processSale('Credit')"><i class="fa fa-credit-card"></i> Credit Sale</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

         <div id="purchase-view" class="view-section">
            <div class="panel">
                <h3><i class="fa fa-cart-plus"></i> Purchase Items (Add Stock)</h3>
                <p>Select items from the list below to add to purchasing cart.</p>
            </div>
             <div class="pos-layout">
                 <div class="pos-left">
                     <div class="item-list-container table-container">
                         <table id="purchase-item-table">
                            <thead><tr><th>Barcode</th><th>Name</th><th>Current Stock</th><th>Cost Price</th><th>Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="pos-right">
                     <div style="padding: 15px; background: var(--theme-orange); color: white; font-weight: bold;">
                        <i class="fa fa-truck-loading"></i> Purchase Cart
                    </div>
                    <div class="cart-items" id="purchase-cart-items"></div>
                    <div class="cart-totals">
                        <div class="total-row"><span>Total Cost:</span><span id="purchase-total-amount">Rs 0.00</span></div>
                        <button class="btn btn-success" style="width:100%; justify-content: center;" onclick="processPurchase()"><i class="fa fa-check"></i> Confirm Purchase</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ledger-view" class="view-section">
            <div class="panel">
                <h3><i class="fa fa-book-open"></i> Customer General Ledger</h3>
                 <div class="form-row">
                    <div class="form-group">
                        <label>Select Customer to manage</label>
                        <select id="ledger-customer-select" onchange="loadCustomerLedger()"><option value="">Select Customer...</option></select>
                    </div>
                     <div class="form-group">
                         <label>Current Balance</label>
                        <input type="text" id="ledger-balance-display" readonly style="font-weight: bold; color: var(--theme-blue);">
                    </div>
                 </div>
            </div>
            
            <div class="form-row">
                <div class="panel" style="flex:1;">
                    <h3>Add Payment (Cr)</h3>
                    <div class="form-row">
                        <div class="form-group"><input type="number" id="payment-amount" placeholder="Amount Received"></div>
                        <button class="btn btn-success" onclick="adjustLedger('payment')">Receive Payment</button>
                    </div>
                    <small>Customer pays us. Balance decreases.</small>
                </div>
                 <div class="panel" style="flex:1;">
                    <h3>Add Debit (Dr)</h3>
                    <div class="form-row">
                         <div class="form-group"><input type="number" id="debit-amount" placeholder="Amount Charged"></div>
                        <button class="btn btn-danger" style="background: var(--theme-orange);" onclick="adjustLedger('debit')">Add Charge</button>
                    </div>
                     <small>We charge customer. Balance increases.</small>
                </div>
            </div>
        </div>
         <div id="hr-view" class="view-section">
            <div class="form-row">
                <div class="panel" style="flex: 1;">
                    <h3><i class="fa fa-receipt"></i> Record Expense</h3>
                    <div class="form-group"><label>Description</label><input type="text" id="exp-desc" placeholder="e.g., Electricity Bill"></div>
                    <div class="form-group"><label>Amount</label><input type="number" id="exp-amount"></div>
                     <button class="btn btn-danger" onclick="addExpense()">Record Expense</button>
                     <hr style="margin: 15px 0;">
                     <h4>Recent Expenses</h4>
                     <ul id="expense-list" style="padding-left: 20px;"></ul>
                </div>

                <div class="panel" style="flex: 1;">
                     <h3><i class="fa fa-calendar-check"></i> Employee Attendance</h3>
                      <div class="form-group"><label>Employee Name</label><input type="text" id="emp-name"></div>
                      <div class="form-group"><label>Status</label>
                          <select id="emp-status"><option>Present</option><option>Absent</option><option>Half Day</option></select>
                      </div>
                     <button class="btn btn-teal" onclick="markAttendance()">Mark Attendance</button>
                      <hr style="margin: 15px 0;">
                     <h4>Today's Attendance</h4>
                     <ul id="attendance-list" style="padding-left: 20px;"></ul>
                 </div>
            </div>
        </div>

    </div> <div id="toast">Notification</div>

    <script>
        // --- CENTRAL DATA STATE (Simulating a Database) ---
        let AppState = {
            categories: ['General', 'Food', 'Electronics'],
            customers: [], // {id, name, phone, balance}
            products: [],  // {barcode, name, category, cost, price, stock}
            sales: [],     // {id, total, profit, type, date}
            purchases: [], // {id, total, date}
            expenses: [],  // {desc, amount}
            heldBills: []  // {id, timestamp, cartItems: []}
        };

        // Temporary Carts
        let posCart = [];
        let purchaseCart = [];

        // --- INITIALIZATION & NAVIGATION ---
        function init() {
            // Try to load data from LocalStorage if it exists
            const savedData = localStorage.getItem('bizRocketData');
            if (savedData) {
                 AppState = JSON.parse(savedData);
            }

            updateDashboard();
            populateCategoryDropdowns();
            renderCustomerTable();
            renderProductTable();
            populateCustomerSelects();
            renderPosItemList();
            renderPurchaseItemList();
            updateExpenseList();
        }

        function saveData() {
            localStorage.setItem('bizRocketData', JSON.stringify(AppState));
            updateDashboard();
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId + '-view').classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        }

        function formatCurrency(amount) {
            return "Rs " + parseFloat(amount).toFixed(2);
        }

        // --- DASHBOARD UPDATES ---
        function updateDashboard() {
            const totalSales = AppState.sales.reduce((sum, s) => sum + s.total, 0);
            const cashSales = AppState.sales.filter(s => s.type === 'Cash').reduce((sum, s) => sum + s.total, 0);
            const creditSales = AppState.sales.filter(s => s.type === 'Credit').reduce((sum, s) => sum + s.total, 0);
            const totalPurchases = AppState.purchases.reduce((sum, p) => sum + p.total, 0);
            const stockValue = AppState.products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            
            const grossProfit = AppState.sales.reduce((sum, s) => sum + s.profit, 0);
            const totalExpenses = AppState.expenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = grossProfit - totalExpenses;

            document.getElementById('dash-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('dash-cash-sales').textContent = formatCurrency(cashSales);
            document.getElementById('dash-credit-sales').textContent = formatCurrency(creditSales);
            document.getElementById('dash-purchases').textContent = formatCurrency(totalPurchases);
            document.getElementById('dash-stock-value').textContent = formatCurrency(stockValue);
            document.getElementById('dash-profit').textContent = formatCurrency(netProfit);
        }

        // --- MASTERS (SETUP) FUNCTIONS ---
        function addCategory() {
            const input = document.getElementById('new-category');
            if(input.value && !AppState.categories.includes(input.value)) {
                AppState.categories.push(input.value);
                input.value = '';
                populateCategoryDropdowns();
                saveData();
                showToast("Category Added");
            }
        }

        function populateCategoryDropdowns() {
             const display = document.getElementById('category-list-display');
             display.innerHTML = AppState.categories.map(c => `<span style="background:#dee2e6; padding: 5px 10px; border-radius:10px;">${c}</span>`).join('');

             const prodSelect = document.getElementById('prod-cat');
             prodSelect.innerHTML = AppState.categories.map(c => `<option>${c}</option>`).join('');
        }

        function addCustomer() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            if(!name) return alert("Name required");
            AppState.customers.push({ id: Date.now(), name, phone, balance: 0 });
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            renderCustomerTable();
            populateCustomerSelects();
            saveData();
            showToast("Customer Profile Saved");
        }

        function renderCustomerTable() {
            const tbody = document.querySelector('#customer-table tbody');
            tbody.innerHTML = AppState.customers.map(c => `
                <tr><td>${c.id}</td><td>${c.name}</td><td>${c.phone}</td>
                <td style="font-weight:bold; color:${c.balance > 0 ? 'red' : 'green'}">${formatCurrency(c.balance)}</td></tr>
            `).join('');
        }

        function populateCustomerSelects() {
            const options = `<option value="">Select Customer...</option>` + 
                            AppState.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('pos-customer-select').innerHTML = options;
            document.getElementById('ledger-customer-select').innerHTML = options;
        }


        // --- PRODUCTS & STOCK FUNCTIONS ---
        function addProduct() {
            const barcode = document.getElementById('prod-barcode').value;
            const name = document.getElementById('prod-name').value;
            const cat = document.getElementById('prod-cat').value;
            const cost = parseFloat(document.getElementById('prod-cost').value) || 0;
            const price = parseFloat(document.getElementById('prod-price').value) || 0;

            if(!barcode || !name) return alert("Barcode and Name required");
            if(AppState.products.find(p => p.barcode === barcode)) return alert("Barcode exists!");

            AppState.products.push({ barcode, name, category: cat, cost, price, stock: 0 });
            
            ['prod-barcode', 'prod-name', 'prod-cost', 'prod-price'].forEach(id => document.getElementById(id).value = '');
            renderProductTable();
            renderPosItemList();
            renderPurchaseItemList();
            saveData();
            showToast("Product Added successfully");
        }

        function renderProductTable() {
             const tbody = document.querySelector('#product-table tbody');
             tbody.innerHTML = AppState.products.map(p => `
                <tr>
                    <td>${p.barcode}</td><td>${p.name}</td><td>${p.category}</td>
                    <td>${formatCurrency(p.cost)}</td><td>${formatCurrency(p.price)}</td>
                    <td style="font-weight:bold;">${p.stock}</td><td>${formatCurrency(p.stock * p.cost)}</td>
                </tr>
            `).join('');
        }

        // --- POS TRANSACTION FUNCTIONS ---
        function renderPosItemList() {
             const search = document.getElementById('pos-search').value.toLowerCase();
             const tbody = document.querySelector('#pos-item-table tbody');
             tbody.innerHTML = AppState.products
                .filter(p => p.name.toLowerCase().includes(search) || p.barcode.includes(search))
                .map(p => `
                <tr>
                    <td>${p.barcode}</td><td>${p.name}</td>
                    <td style="color:${p.stock<=0?'red':'inherit'}">${p.stock}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td><button class="btn btn-teal" style="padding:5px 10px; font-size:0.8rem" onclick="addToPosCart('${p.barcode}')">Add</button></td>
                </tr>
            `).join('');
        }

        function simulateBarcodeScan() {
            const barcode = prompt("SCAN BARCODE NOW (Enter barcode number):");
            if(barcode) addToPosCart(barcode);
        }

        function addToPosCart(barcode) {
            const product = AppState.products.find(p => p.barcode === barcode);
            if(!product) return alert("Product not found!");
            if(product.stock <= 0) return alert("Out of stock!");

            const cartItem = posCart.find(i => i.barcode === barcode);
            if(cartItem) {
                if(cartItem.qty < product.stock) cartItem.qty++;
            } else {
                posCart.push({ ...product, qty: 1 });
            }
            renderPosCart();
        }

        function removeFromPosCart(barcode) {
            posCart = posCart.filter(i => i.barcode !== barcode);
            renderPosCart();
        }

        function renderPosCart() {
            const container = document.getElementById('pos-cart-items');
            container.innerHTML = '';
            let total = 0;
            posCart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; background:white;">
                        <div><b>${item.name}</b><br><small>${item.qty} x ${item.price}</small></div>
                         <div style="display:flex; align-items:center; gap:10px;">
                            <span>${formatCurrency(item.price * item.qty)}</span>
                            <i class="fa fa-trash" style="color:red; cursor:pointer;" onclick="removeFromPosCart('${item.barcode}')"></i>
                        </div>
                    </div>`;
            });
            document.getElementById('pos-total-amount').textContent = formatCurrency(total);
        }

        function holdBill() {
            if(posCart.length === 0) return alert("Cart empty");
            AppState.heldBills.push({ id: Date.now(), timestamp: new Date().toLocaleTimeString(), cartItems: [...posCart] });
            posCart = [];
            renderPosCart();
            saveData();
            showToast("Bill Held Successfully");
        }
        
        function showHeldBills() {
            if(AppState.heldBills.length === 0) return alert("No held bills.");
            let listStr = "Select ID to recall:\n";
            AppState.heldBills.forEach((bill, index) => { listStr += `${index + 1}. ID: ${bill.id} (Time: ${bill.timestamp})\n`; });
            const selection = prompt(listStr);
            if(selection && selection > 0 && selection <= AppState.heldBills.length) {
                posCart = AppState.heldBills[selection - 1].cartItems;
                AppState.heldBills.splice(selection - 1, 1); // Remove after recall
                renderPosCart();
                saveData();
            }
        }

        function processSale(type) {
            if(posCart.length === 0) return alert("Cart empty");
            const custId = document.getElementById('pos-customer-select').value;

            if(type === 'Credit' && !custId) return alert("Please select a customer for Credit Sale.");

            let saleTotal = 0;
            let saleProfit = 0;

            // Decrease Stock and calculate profit
            posCart.forEach(cartItem => {
                const product = AppState.products.find(p => p.barcode === cartItem.barcode);
                product.stock -= cartItem.qty;
                saleTotal += cartItem.price * cartItem.qty;
                saleProfit += (cartItem.price - cartItem.cost) * cartItem.qty;
            });

            // If Credit, update Ledger balance
            if(type === 'Credit') {
                const customer = AppState.customers.find(c => c.id == custId);
                customer.balance += saleTotal;
            }

            // Log Sale
            AppState.sales.push({ id: Date.now(), total: saleTotal, profit: saleProfit, type: type, date: new Date() });

            // Reset
            posCart = [];
            renderPosCart();
            renderProductTable(); // Update stock view
            renderPosItemList(); // Update pos list stock
            renderCustomerTable(); // Update ledger view
            document.getElementById('pos-customer-select').value = '';
            saveData();
            showToast(`${type} Sale Complete!`);
        }

        // --- PURCHASE FUNCTIONS ---
         function renderPurchaseItemList() {
             const tbody = document.querySelector('#purchase-item-table tbody');
             tbody.innerHTML = AppState.products.map(p => `
                <tr>
                    <td>${p.barcode}</td><td>${p.name}</td><td>${p.stock}</td>
                    <td>${formatCurrency(p.cost)}</td>
                    <td><button class="btn btn-orange" style="background: var(--theme-orange); color:white; padding:5px 10px;" onclick="addToPurchaseCart('${p.barcode}')">Add to Purchase</button></td>
                </tr>
            `).join('');
        }
        
        function addToPurchaseCart(barcode) {
             const product = AppState.products.find(p => p.barcode === barcode);
             const cartItem = purchaseCart.find(i => i.barcode === barcode);
             if(cartItem) { cartItem.qty++; } else { purchaseCart.push({ ...product, qty: 1 }); }
             renderPurchaseCart();
        }

        function renderPurchaseCart() {
            const container = document.getElementById('purchase-cart-items');
            container.innerHTML = '';
            let total = 0;
            purchaseCart.forEach(item => {
                total += item.cost * item.qty; // Purchase uses COST price
                container.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; background:white;"><b>${item.name}</b>: ${item.qty} x ${item.cost} = ${formatCurrency(item.cost * item.qty)}</div>`;
            });
            document.getElementById('purchase-total-amount').textContent = formatCurrency(total);
        }

        function processPurchase() {
            if(purchaseCart.length === 0) return alert("Purchase Cart empty");
            let purchaseTotal = 0;
            purchaseCart.forEach(cartItem => {
                 const product = AppState.products.find(p => p.barcode === cartItem.barcode);
                 product.stock += cartItem.qty; // Increase stock
                 purchaseTotal += cartItem.cost * cartItem.qty;
            });
             AppState.purchases.push({ id: Date.now(), total: purchaseTotal, date: new Date() });
             purchaseCart = [];
             renderPurchaseCart();
             renderProductTable();
             renderPurchaseItemList();
             saveData();
             showToast("Purchase Stock Added!");
        }


        // --- LEDGER FUNCTIONS ---
        function loadCustomerLedger() {
             const custId = document.getElementById('ledger-customer-select').value;
             const display = document.getElementById('ledger-balance-display');
             if(!custId) { display.value = ''; return;}
             const customer = AppState.customers.find(c => c.id == custId);
             display.value = formatCurrency(customer.balance);
             display.style.color = customer.balance > 0 ? 'red' : 'green';
        }

        function adjustLedger(type) {
            const custId = document.getElementById('ledger-customer-select').value;
            if(!custId) return alert("Select customer first");
            const customer = AppState.customers.find(c => c.id == custId);

            if(type === 'payment') {
                const amount = parseFloat(document.getElementById('payment-amount').value) || 0;
                if(amount > 0) {
                    customer.balance -= amount; // Balance decreases when they pay us
                    document.getElementById('payment-amount').value = '';
                    showToast("Payment Recorded");
                }
            } else {
                const amount = parseFloat(document.getElementById('debit-amount').value) || 0;
                 if(amount > 0) {
                    customer.balance += amount; // Balance increases when we charge them
                    document.getElementById('debit-amount').value = '';
                    showToast("Debit Recorded");
                }
            }
            loadCustomerLedger();
            renderCustomerTable();
            saveData();
        }

        // --- HR & EXPENSE FUNCTIONS ---
        function addExpense() {
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
            if(!desc || amount <= 0) return alert("Invalid expense details");

            AppState.expenses.unshift({ desc, amount, date: new Date().toLocaleTimeString() });
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
            updateExpenseList();
            saveData();
            showToast("Expense Recorded");
        }

        function updateExpenseList() {
             const list = document.getElementById('expense-list');
             list.innerHTML = AppState.expenses.slice(0, 5).map(e => `<li>${e.desc} - ${formatCurrency(e.amount)} (${e.date})</li>`).join('');
        }

        function markAttendance() {
             const name = document.getElementById('emp-name').value;
             const status = document.getElementById('emp-status').value;
             if(!name) return alert("Name required");
             const list = document.getElementById('attendance-list');
             list.innerHTML += `<li>${name} - <b>${status}</b> (${new Date().toLocaleTimeString()})</li>`;
             showToast("Attendance Marked");
        }

        // Start the app
        init();
    </script>
</body>
</html>
